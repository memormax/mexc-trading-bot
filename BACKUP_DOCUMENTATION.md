# Документация проекта - Версия 2026-02-04

## Общая информация

**Название проекта:** Unified Trading Bot (MEXC Futures Trading Platform)  
**Версия:** 1.0.0  
**Порт:** 3002  
**Дата создания документации:** 2026-02-04 15:58:11

Проект представляет собой платформу для торговли фьючерсами на бирже MEXC, состоящую из трех основных компонентов:
1. **Flip Bot** - автоматический арбитражный торговый бот
2. **Ferm Service** - сервис для ручной торговли на нескольких аккаунтах одновременно
3. **Welcome Page** - главная страница с навигацией

---

## Архитектура проекта

### Структура директорий

```
unified-bot/
├── server.ts                    # Главный сервер (Express.js)
├── services/                    # Независимые сервисы
│   ├── flip/                   # Flip Bot Service
│   │   ├── ui/                 # Пользовательский интерфейс
│   │   │   ├── index.html      # Главная страница Flip Bot
│   │   │   ├── app.js          # Клиентская логика
│   │   │   ├── styles.css      # Стили
│   │   │   └── ...
│   │   ├── src/                # Исходный код сервиса
│   │   │   ├── api-key-client.ts
│   │   │   ├── spot-api-client.ts
│   │   │   ├── trading/
│   │   │   ├── monitor/
│   │   │   └── websocket/
│   │   ├── index.ts            # Регистрация маршрутов
│   │   ├── routes.ts           # API маршруты
│   │   └── handlers.ts        # Обработчики запросов
│   └── ferm/                   # Ferm Service
│       ├── ui/                 # Пользовательский интерфейс
│       │   ├── index.html      # Главная страница Ferm
│       │   ├── app.js          # Клиентская логика
│       │   └── styles.css      # Стили
│       ├── index.ts            # Регистрация маршрутов
│       ├── routes.ts           # API маршруты
│       ├── handlers.ts        # Обработчики запросов
│       └── service.ts         # Основная логика сервиса
├── src/                        # Общий исходный код
│   ├── trading-handler.ts     # Обработчик торговых операций
│   ├── api-key-client.ts      # Клиент для API Key/Secret
│   ├── spot-api-client.ts     # Клиент для Spot API
│   ├── monitor/               # Мониторинг цен
│   ├── trading/               # Торговая логика
│   └── websocket/             # WebSocket клиенты
├── ui/                         # Общие UI файлы
│   ├── welcome.html            # Главная страница
│   ├── index.html              # (legacy)
│   └── ...
├── data/                       # Данные приложения
│   ├── ferm-accounts.json      # Аккаунты Ferm Service
│   ├── ferm-history.json       # История операций Ferm
│   └── account-reports.json    # Отчеты Flip Bot
└── dist/                       # Скомпилированный код
```

### Принципы архитектуры

1. **Модульность**: Каждый сервис независим и изолирован
2. **Независимость**: Сервисы могут работать одновременно без конфликтов
3. **Разделение ответственности**: Каждый сервис имеет свои UI, API endpoints и логику
4. **Общие ресурсы**: Общий код вынесен в `src/`, но сервисы используют свои клиенты

---

## 1. Flip Bot Service

### Описание

Автоматический арбитражный торговый бот для работы с фьючерсами MEXC. Бот анализирует разницу цен между Binance и MEXC и автоматически открывает/закрывает позиции для получения прибыли.

### Доступ

- **Веб-интерфейс:** `http://localhost:3002/flip/`
- **API Endpoints:** `http://localhost:3002/api/flip/*`

### Основные функции

1. **Автоматическая арбитражная торговля**
   - Мониторинг цен на Binance и MEXC
   - Автоматическое открытие/закрытие позиций при обнаружении спреда
   - Настройка минимального спреда, максимального спреда, целевой прибыли

2. **Ручная торговля**
   - Создание ордеров вручную
   - Выбор монеты, типа ордера, объема
   - Управление позициями

3. **Управление аккаунтами**
   - Добавление аккаунтов с WEB Token, API Key, API Secret
   - Переключение между аккаунтами
   - Просмотр баланса и истории сделок

4. **Мониторинг**
   - Отслеживание открытых позиций
   - Просмотр истории ордеров
   - Логирование всех операций

### Технические детали

- **Клиент:** Один глобальный `MexcFuturesClient` в `trading-handler.ts`
- **WebSocket:** Подключения к Binance и MEXC для мониторинга цен
- **Хранение данных:** В памяти сервера (аккаунты, настройки)
- **API:** Использует `/api/flip/*` endpoints

### UI Компоненты

- Панель управления подключением
- Панель выбора монеты
- Панель параметров ордера
- Панель быстрых действий (ЛОНГ, ШОРТ, Закрыть)
- Панель мониторинга позиций
- Панель истории ордеров
- Лог операций

---

## 2. Ferm Service

### Описание

Сервис для ручной торговли одновременно на нескольких аккаунтах. Позволяет открывать и закрывать сделки параллельно на выбранных аккаунтах.

### Доступ

- **Веб-интерфейс:** `http://localhost:3002/ferm/`
- **API Endpoints:** `http://localhost:3002/api/ferm/*`

### Основные функции

1. **Управление аккаунтами**
   - Добавление аккаунтов с WEB Token, API Key, API Secret
   - Редактирование и удаление аккаунтов
   - Валидация аккаунтов при добавлении
   - Просмотр статуса и баланса аккаунтов
   - Выбор аккаунтов через чекбоксы или клик по карточке

2. **Параллельная торговля**
   - Создание ордеров одновременно на нескольких выбранных аккаунтах
   - Отмена всех ордеров на выбранных аккаунтах
   - Закрытие позиций на выбранных аккаунтах
   - Обработка ошибок для каждого аккаунта отдельно

3. **Интерфейс**
   - Двухколоночный layout:
     - Левая колонка (750px): Панель аккаунтов (3 столбца карточек)
     - Правая колонка: Настройки ордеров и торговля
   - Кнопки управления аккаунтами над списком:
     - "Выбрать все" / "Снять все"
     - "Балансы" (обновляет балансы всех аккаунтов)

4. **Быстрые действия**
   - ЛОНГ - быстрое открытие лонг позиций
   - ШОРТ - быстрое открытие шорт позиций
   - Закрыть - быстрое закрытие всех позиций

5. **История операций**
   - Просмотр результатов операций по каждому аккаунту
   - Очистка истории

### Технические детали

- **Клиенты:** `Map<string, MexcFuturesClient>` - отдельный клиент для каждого аккаунта
- **Хранение данных:**
  - Аккаунты: `data/ferm-accounts.json`
  - История операций: `data/ferm-history.json`
- **Параллельность:** Использует `Promise.allSettled` для параллельного выполнения операций
- **Точность:** Автоматическое округление объема и цены согласно требованиям MEXC API
- **Минимальный ордер:** Автоматическая проверка минимального объема (5 USDT)

### API Endpoints

#### Управление аккаунтами
- `GET /api/ferm/accounts` - Получить список аккаунтов
- `POST /api/ferm/accounts` - Добавить аккаунт
- `PUT /api/ferm/accounts/:accountId` - Обновить аккаунт
- `DELETE /api/ferm/accounts/:accountId` - Удалить аккаунт
- `POST /api/ferm/accounts/validate` - Валидировать аккаунт

#### Торговые операции
- `POST /api/ferm/operations/submit-order` - Создать ордер на выбранных аккаунтах
- `POST /api/ferm/operations/cancel-all` - Отменить все ордера
- `POST /api/ferm/operations/close-positions` - Закрыть позиции

#### Статус и информация
- `GET /api/ferm/status/accounts/:accountId` - Получить статус аккаунта
- `GET /api/ferm/status/balance/:accountId` - Получить баланс аккаунта
- `GET /api/ferm/status/positions/:accountId` - Получить позиции аккаунта

#### История операций
- `GET /api/ferm/history` - Получить историю операций
- `DELETE /api/ferm/history` - Очистить историю

### UI Компоненты

#### Левая колонка (Аккаунты)
- Заголовок с кнопкой "Добавить"
- Кнопки управления: "Выбрать все", "Снять все", "Балансы"
- Список аккаунтов в 3 столбца:
  - Чекбокс выбора
  - Название аккаунта
  - Статус (Активен/Неактивен/Ошибка)
  - Баланс
  - Кнопки: Проверить, Баланс, Редактировать, Удалить

#### Правая колонка (Торговля)
- Панель "Монета": Выбор символа из списка или ввод своего
- Панель "Параметры ордера":
  - Направление (Лонг/Шорт/Закрыть)
  - Тип ордера (Market/Limit/IOC/FOK/Post Only/Convert)
  - Тип маржи (Isolated/Cross)
  - Плечо, Цена, Объем
  - Стоп-лосс, Тейк-профит
- Панель "Быстрые действия": ЛОНГ, ШОРТ, Закрыть
- Панель "Действия": Создать ордер, Отменить все, Закрыть позиции
- Панель "Результаты операций": История операций с результатами по каждому аккаунту

### Особенности реализации

1. **Выбор символа:** Приоритет у поля "Или свой:" - если заполнено, используется оно, иначе значение из выпадающего списка
2. **Сохранение выбора:** Выбранные аккаунты сохраняются при обновлении списка
3. **Обработка ошибок:** Каждый аккаунт обрабатывается независимо, ошибки фиксируются отдельно
4. **Конвертация объема:** Автоматическая конвертация USDT в объем монеты с учетом текущей цены
5. **Точность:** Автоматическое применение `priceScale` и `volScale` из контракта

---

## 3. Welcome Page (Главная страница)

### Описание

Главная страница приложения с навигацией к сервисам Flip Bot и Ferm.

### Доступ

- **URL:** `http://localhost:3002/` или `http://localhost:3002/welcome.html`

### Функции

- Ссылки на Flip Bot (`/flip/`)
- Ссылки на Ferm Service (`/ferm/`)
- Информация о проекте

---

## Технические детали

### Зависимости

```json
{
  "mexc-futures-sdk": "^1.5.1",
  "express": "^4.18.2",
  "cors": "^2.8.5",
  "ws": "^8.14.2",
  "axios": "^1.6.0",
  "md5": "^2.3.0"
}
```

### Скрипты

- `npm run build` - Компиляция TypeScript и копирование UI файлов
- `npm start` - Сборка и запуск сервера
- `npm run dev` - Режим разработки с watch
- `npm run watch` - Отслеживание изменений TypeScript

### Конфигурация

- **Порт:** 3002 (по умолчанию)
- **Хост:** 0.0.0.0 (по умолчанию)
- **Node.js:** >=18.0.0
- **npm:** >=9.0.0

### Структура данных

#### FermAccount (Ferm Service)
```typescript
interface FermAccount {
  id: string;
  name: string;
  webToken: string;
  apiKey?: string;
  apiSecret?: string;
  status: 'active' | 'inactive' | 'error';
  lastCheck?: number;
  balance?: number;
  errorMessage?: string;
  selected: boolean;
}
```

### Безопасность

- WEB Token используется для торговых операций
- API Key/Secret используются только для проверки баланса и истории (не для торговли)
- Каждый сервис использует свои клиенты, изолированные друг от друга

### Производительность

- Параллельная обработка операций на нескольких аккаунтах (Promise.allSettled)
- Кэширование данных контрактов для уменьшения API запросов
- Оптимизированная обработка WebSocket соединений

---

## Независимость сервисов

### Flip Bot и Ferm Service работают независимо:

1. **Разные API endpoints:**
   - Flip: `/api/flip/*`
   - Ferm: `/api/ferm/*`

2. **Разные клиенты:**
   - Flip: Один глобальный `MexcFuturesClient` в `trading-handler.ts`
   - Ferm: `Map<string, MexcFuturesClient>` - отдельный клиент для каждого аккаунта

3. **Разные файлы данных:**
   - Ferm: `data/ferm-accounts.json`, `data/ferm-history.json`
   - Flip: Данные в памяти сервера

4. **Разные UI:**
   - Flip: `services/flip/ui/`
   - Ferm: `services/ferm/ui/`

### Одновременная работа

✅ **Да, сервисы могут работать одновременно:**
- Flip Bot может торговать автоматически на одном аккаунте
- Ferm может открывать/закрывать сделки вручную на нескольких аккаунтах
- Они не конфликтуют, так как используют разные клиенты и endpoints

⚠️ **Важно:** Если один и тот же аккаунт используется одновременно в обоих сервисах, возможны конфликты на стороне биржи (один аккаунт, разные сессии).

---

## Известные особенности

1. **Ferm Service:**
   - Кнопка "Балансы" обновляет балансы всех аккаунтов, независимо от выбора
   - Выбранные аккаунты сохраняются при обновлении списка
   - Приоритет у поля "Или свой:" при выборе символа
   - Автоматическая проверка минимального объема ордера (5 USDT)

2. **Flip Bot:**
   - Использует один глобальный клиент для всех операций
   - WebSocket соединения для мониторинга цен Binance и MEXC

---

## Развертывание

### Локальное развертывание

```bash
npm install
npm run build
npm start
```

### Production развертывание

```bash
npm run build
npm run start:prod
# или с PM2:
npm run pm2:start
```

---

## Поддержка и обновления

Документация актуальна на дату создания. При внесении изменений в проект рекомендуется обновлять эту документацию.

---

## Контакты и информация

- **Проект:** Unified Trading Bot
- **Версия:** 1.0.0
- **Дата:** 2026-02-04 15:58:11

---

*Документация создана для резервного копирования текущей версии проекта.*
