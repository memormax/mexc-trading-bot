# Оптимизация производительности - Анализ таймингов

## Текущие тайминги (локально, пинг 300ms)

### Детект сигнала
- **processSpread()**: <1ms (синхронно, без запросов)
- **Итого**: <1ms

### Обработка сигнала (onSignal)
1. **calculateAutoVolume()** (если автообъем включен):
   - Проверка кэша: <1ms
   - Если кэш устарел: HTTP запрос к MEXC API = **300ms**
   - Расчет объема: <1ms
   - **Итого**: <1ms (кэш) или **301ms** (без кэша)

2. **Логирование**: ~2-5ms (убрано в оптимизации)

### Открытие позиции (openPosition)
1. **Получение контракта**:
   - Проверка кэша: <1ms
   - Если кэш устарел: HTTP запрос = **300ms**
   - **Итого**: <1ms (кэш) или **301ms** (без кэша)

2. **Проверка баланса** (оптимизировано - используем кэш из calculateAutoVolume):
   - Проверка кэша: <1ms
   - Если кэш устарел: HTTP запрос = **300ms** (убрано в оптимизации)
   - **Итого**: <1ms (всегда используем кэш)

3. **Расчет параметров ордера**: <1ms

4. **MIN_ORDER_INTERVAL**: до **500ms** (уменьшено до 200ms в оптимизации)
   - **Итого**: 0-500ms (зависит от времени последнего ордера)

5. **submitOrder()**: HTTP запрос к MEXC API = **300ms**

6. **Логирование**: ~5-10ms (убрано в оптимизации)

### Закрытие позиции (closePosition)
1. **getOpenPositions()**: HTTP запрос = **300ms**

2. **getContractDetail()** (оптимизировано - используем кэш):
   - Проверка кэша: <1ms
   - Если кэш устарел: HTTP запрос = **300ms**
   - **Итого**: <1ms (кэш) или **301ms** (без кэша)

3. **Расчет параметров**: <1ms

4. **MIN_ORDER_INTERVAL**: до **500ms** (уменьшено до 200ms)
   - **Итого**: 0-500ms

5. **submitOrder()**: HTTP запрос = **300ms**

6. **Логирование**: ~10-15ms (убрано в оптимизации)

---

## Тайминги ДО оптимизации (локально, пинг 300ms)

### Открытие позиции (худший случай - все кэши устарели):
- Детект сигнала: <1ms
- calculateAutoVolume (без кэша): 301ms
- Логирование: 5ms
- Получение контракта (без кэша): 301ms
- Проверка баланса (без кэша): 301ms
- MIN_ORDER_INTERVAL: 500ms
- submitOrder: 300ms
- Логирование: 10ms
- **ИТОГО: ~1418ms (1.4 секунды)**

### Открытие позиции (лучший случай - все в кэше):
- Детект сигнала: <1ms
- calculateAutoVolume (кэш): <1ms
- Получение контракта (кэш): <1ms
- Проверка баланса (кэш): <1ms
- MIN_ORDER_INTERVAL: 0ms (если прошло >500ms)
- submitOrder: 300ms
- **ИТОГО: ~303ms (0.3 секунды)**

### Закрытие позиции (худший случай):
- getOpenPositions: 300ms
- getContractDetail (без кэша): 301ms
- MIN_ORDER_INTERVAL: 500ms
- submitOrder: 300ms
- Логирование: 15ms
- **ИТОГО: ~1116ms (1.1 секунды)**

### Закрытие позиции (лучший случай):
- getOpenPositions: 300ms
- getContractDetail (кэш): <1ms
- MIN_ORDER_INTERVAL: 0ms
- submitOrder: 300ms
- **ИТОГО: ~601ms (0.6 секунды)**

---

## Тайминги ПОСЛЕ оптимизации (локально, пинг 300ms)

### Открытие позиции (худший случай):
- Детект сигнала: <1ms
- calculateAutoVolume (без кэша): 301ms
- Получение контракта (без кэша): 301ms
- Проверка баланса (используем кэш из calculateAutoVolume): <1ms
- MIN_ORDER_INTERVAL: 200ms (уменьшено с 500ms)
- submitOrder: 300ms
- **ИТОГО: ~803ms (0.8 секунды)** ⚡ **Улучшение: -615ms (-43%)**

### Открытие позиции (лучший случай):
- Детект сигнала: <1ms
- calculateAutoVolume (кэш): <1ms
- Получение контракта (кэш): <1ms
- Проверка баланса (кэш): <1ms
- MIN_ORDER_INTERVAL: 0ms (если прошло >200ms)
- submitOrder: 300ms
- **ИТОГО: ~303ms (0.3 секунды)** ⚡ **Без изменений (уже оптимально)**

### Закрытие позиции (худший случай):
- getOpenPositions: 300ms
- getContractDetail (кэш): <1ms
- MIN_ORDER_INTERVAL: 200ms (уменьшено с 500ms)
- submitOrder: 300ms
- **ИТОГО: ~501ms (0.5 секунды)** ⚡ **Улучшение: -615ms (-55%)**

### Закрытие позиции (лучший случай):
- getOpenPositions: 300ms
- getContractDetail (кэш): <1ms
- MIN_ORDER_INTERVAL: 0ms
- submitOrder: 300ms
- **ИТОГО: ~301ms (0.3 секунды)** ⚡ **Улучшение: -300ms (-50%)**

---

## Тайминги на сервере (пинг 10ms)

### Открытие позиции (худший случай):
- Детект сигнала: <1ms
- calculateAutoVolume (без кэша): 11ms
- Получение контракта (без кэша): 11ms
- Проверка баланса (кэш): <1ms
- MIN_ORDER_INTERVAL: 200ms
- submitOrder: 10ms
- **ИТОГО: ~233ms (0.23 секунды)** ⚡

### Открытие позиции (лучший случай):
- Детект сигнала: <1ms
- calculateAutoVolume (кэш): <1ms
- Получение контракта (кэш): <1ms
- Проверка баланса (кэш): <1ms
- MIN_ORDER_INTERVAL: 0ms
- submitOrder: 10ms
- **ИТОГО: ~13ms (0.013 секунды)** ⚡⚡⚡

### Закрытие позиции (худший случай):
- getOpenPositions: 10ms
- getContractDetail (кэш): <1ms
- MIN_ORDER_INTERVAL: 200ms
- submitOrder: 10ms
- **ИТОГО: ~221ms (0.22 секунды)** ⚡

### Закрытие позиции (лучший случай):
- getOpenPositions: 10ms
- getContractDetail (кэш): <1ms
- MIN_ORDER_INTERVAL: 0ms
- submitOrder: 10ms
- **ИТОГО: ~21ms (0.021 секунды)** ⚡⚡⚡

---

## Сводная таблица

| Операция | Локально (300ms) ДО | Локально (300ms) ПОСЛЕ | Сервер (10ms) ПОСЛЕ | Улучшение |
|----------|---------------------|------------------------|---------------------|-----------|
| **Открытие (худший)** | 1418ms | 803ms | 233ms | **-43% / -83%** |
| **Открытие (лучший)** | 303ms | 303ms | 13ms | **0% / -96%** |
| **Закрытие (худший)** | 1116ms | 501ms | 221ms | **-55% / -80%** |
| **Закрытие (лучший)** | 601ms | 301ms | 21ms | **-50% / -97%** |

---

## Выполненные оптимизации

1. ✅ **Убрано лишнее логирование** из критичных путей (onSignal, openPosition, closePosition)
2. ✅ **Оптимизирована проверка баланса** - используем кэш из calculateAutoVolume вместо повторного запроса
3. ✅ **Уменьшен MIN_ORDER_INTERVAL** с 500ms до 200ms
4. ✅ **Оптимизирован closePosition** - используем кэш контракта вместо запроса к API
5. ✅ **Убраны лишние логи** в closePosition

---

## Рекомендации для дальнейшей оптимизации

1. **Параллельные запросы**: Если нужно получить контракт и баланс одновременно, можно делать параллельно
2. **WebSocket для баланса**: Использовать WebSocket для получения баланса в реальном времени (если MEXC поддерживает)
3. **Предзагрузка данных**: Загружать контракт и баланс заранее, до появления сигнала
4. **Уменьшить MIN_ORDER_INTERVAL**: Можно попробовать 100ms, но нужно тестировать на rate limiting

---

## Итог

**На локальном сервере (пинг 300ms):**
- Открытие позиции: **улучшено на 43%** (с 1.4с до 0.8с в худшем случае)
- Закрытие позиции: **улучшено на 55%** (с 1.1с до 0.5с в худшем случае)

**На сервере (пинг 10ms):**
- Открытие позиции: **~233ms** в худшем случае, **~13ms** в лучшем
- Закрытие позиции: **~221ms** в худшем случае, **~21ms** в лучшем

**Критический путь (лучший случай на сервере):**
- Детект сигнала → Открытие позиции: **~13ms** ⚡⚡⚡
- Сигнал закрытия → Закрытие позиции: **~21ms** ⚡⚡⚡

