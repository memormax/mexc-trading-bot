<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="/ferm/styles.css">
    <style>
        .btn-success { background: #22c55e; }
        .btn-danger { background: #ef4444; }
        .btn-secondary { background: #64748b; }
        .btn-info { background: #3b82f6; }
        .btn-warning { background: #f59e0b; }
        .btn-primary { background: #3b82f6; }
        button { padding: 8px 16px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 14px; }
        button:hover { opacity: 0.9; }
    </style>
    <style>
        body {
            background: #0f172a;
            color: #f1f5f9;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #334155;
        }
        h1 {
            color: #f1f5f9;
            margin: 0;
        }
        .section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #60a5fa;
            margin-top: 0;
            margin-bottom: 16px;
        }
        .user-item {
            padding: 12px;
            border-bottom: 1px solid #334155;
            margin-bottom: 8px;
        }
        .user-item:last-child {
            border-bottom: none;
        }
        .btn-small {
            padding: 4px 12px;
            font-size: 11px;
        }
        .bot-status {
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        .bot-status.active {
            border-color: #22c55e;
        }
        .bot-status.queued {
            border-color: #f59e0b;
        }
        .queue-item {
            padding: 8px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <span id="currentUsername" style="color: #94a3b8; font-size: 12px;"></span>
                <button class="btn-danger" onclick="logout()" style="padding: 6px 12px; font-size: 12px;">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <!-- –°—Ç–∞—Ç—É—Å Flipbot -->
        <section class="section">
            <h2>ü§ñ –°—Ç–∞—Ç—É—Å Flipbot</h2>
            <div id="botStatus" class="bot-status">
                <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <button class="btn-danger btn-small" onclick="forceStopBot()" style="display: none;" id="forceStopBtn">–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </section>

        <!-- –û—á–µ—Ä–µ–¥—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <section class="section">
            <h2>üìã –û—á–µ—Ä–µ–¥—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Flipbot</h2>
            <div id="queueList"></div>
        </section>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <section class="section">
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            <form id="createUserForm" style="margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="newUsername" placeholder="–õ–æ–≥–∏–Ω" required style="padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
                    <input type="password" id="newPassword" placeholder="–ü–∞—Ä–æ–ª—å" required style="padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
                    <select id="newUserRole" style="padding: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                    <button type="submit" class="btn-success btn-small">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="color: #60a5fa; margin-bottom: 12px;">üåæ Ferm</h3>
                    <div id="usersListFerm"></div>
                </div>
                <div>
                    <h3 style="color: #60a5fa; margin-bottom: 12px;">ü§ñ Flipbot</h3>
                    <div id="usersListFlipbot"></div>
                </div>
            </div>
        </section>
    </div>

    <script>
        let currentUser = null;

        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/ferm/auth/check', { credentials: 'include' });
                const result = await response.json();
                if (result.success && result.authenticated) {
                    currentUser = result.data;
                    document.getElementById('currentUsername').textContent = currentUser.username;
                } else {
                    window.location.href = '/ferm/login';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                window.location.href = '/ferm/login';
            }
        }

        async function loadBotStatus() {
            try {
                const response = await fetch('/api/admin/bot-status', { credentials: 'include' });
                const result = await response.json();
                if (result.success) {
                    const statusDiv = document.getElementById('botStatus');
                    const forceStopBtn = document.getElementById('forceStopBtn');
                    
                    if (result.data.locked) {
                        statusDiv.className = 'bot-status active';
                        statusDiv.innerHTML = `
                            <div><strong>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${result.data.currentUsername || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
                            <div><strong>–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:</strong> ${new Date(result.data.startTime).toLocaleString('ru-RU')}</div>
                        `;
                        forceStopBtn.style.display = 'inline-block';
                    } else {
                        statusDiv.className = 'bot-status';
                        statusDiv.innerHTML = '<div>–ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω</div>';
                        forceStopBtn.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞:', error);
            }
        }

        async function loadQueue() {
            try {
                const response = await fetch('/api/admin/bot-queue', { credentials: 'include' });
                const result = await response.json();
                if (result.success) {
                    const queueList = document.getElementById('queueList');
                    if (result.data.queue && result.data.queue.length > 0) {
                        queueList.innerHTML = result.data.queue.map((item, index) => `
                            <div class="queue-item">
                                <strong>${index + 1}.</strong> ${item.username} (–¥–æ–±–∞–≤–ª–µ–Ω: ${new Date(item.addedAt).toLocaleString('ru-RU')})
                            </div>
                        `).join('');
                    } else {
                        queueList.innerHTML = '<div style="color: #94a3b8;">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</div>';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–µ—Ä–µ–¥–∏:', error);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users-data', { credentials: 'include' });
                const result = await response.json();
                if (result.success) {
                    const usersListFerm = document.getElementById('usersListFerm');
                    const usersListFlipbot = document.getElementById('usersListFlipbot');
                    
                    usersListFerm.innerHTML = result.data.map(user => `
                        <div class="user-item" data-user-id="${user.id}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="color: #f1f5f9; font-weight: 600; margin-bottom: 4px;">
                                        ${user.username} ${user.role === 'admin' ? '(–ê–¥–º–∏–Ω)' : ''}
                                    </div>
                                    <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">
                                        –ê–∫–∫–∞—É–Ω—Ç–æ–≤: ${user.ferm.accountsCount}
                                    </div>
                                    <div style="color: #64748b; font-size: 11px;">
                                        –°–æ–∑–¥–∞–Ω: ${new Date(user.createdAt).toLocaleString('ru-RU')}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-direction: column;">
                                    <button class="btn-info btn-small" onclick="checkFermBalances('${user.id}', '${user.username}', event)">–ë–∞–ª–∞–Ω—Å—ã</button>
                                    <button class="btn-success btn-small" onclick="exportFermAccounts('${user.id}', '${user.username}')">–≠–∫—Å–ø–æ—Ä—Ç</button>
                                    <button class="btn-warning btn-small" onclick="importFermAccounts('${user.id}', '${user.username}')">–ò–º–ø–æ—Ä—Ç</button>
                                    ${user.role !== 'admin' ? `
                                        <button class="btn-danger btn-small" onclick="deleteUser('${user.id}', '${user.username}')">–£–¥–∞–ª–∏—Ç—å</button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    usersListFlipbot.innerHTML = result.data.map(user => `
                        <div class="user-item" data-user-id="${user.id}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="color: #f1f5f9; font-weight: 600; margin-bottom: 4px;">
                                        ${user.username} ${user.role === 'admin' ? '(–ê–¥–º–∏–Ω)' : ''}
                                        ${user.flipbot.isBotOwner ? ' <span style="color: #22c55e;">(–¢–æ—Ä–≥—É–µ—Ç)</span>' : ''}
                                    </div>
                                    <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">
                                        –ê–∫–∫–∞—É–Ω—Ç–æ–≤: ${user.flipbot.accountsCount}
                                    </div>
                                    ${user.flipbot.config ? `
                                        <div style="color: #64748b; font-size: 11px; margin-bottom: 2px;">
                                            –ú—É–ª—å—Ç–∏–∞–∫–∫–∞—É–Ω—Ç–∏–Ω–≥: ${user.flipbot.config.enabled ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'}
                                        </div>
                                    ` : ''}
                                    <div style="color: #64748b; font-size: 11px;">
                                        –°–æ–∑–¥–∞–Ω: ${new Date(user.createdAt).toLocaleString('ru-RU')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            }
        }
        
        async function checkFermBalances(userId, username, event) {
            try {
                const button = event?.target || document.querySelector(`button[onclick*="checkFermBalances('${userId}'"]`);
                if (button) {
                    button.disabled = true;
                    button.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
                }
                
                const response = await fetch(`/api/ferm/admin/users/${userId}/check-balances`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (button) {
                    button.disabled = false;
                    button.textContent = '–ë–∞–ª–∞–Ω—Å—ã';
                }
                
                if (result.success) {
                    if (result.data && result.data.balances && result.data.balances.length > 0) {
                        const balancesText = result.data.balances.map(b => `${b.name}: ${b.balance.toFixed(2)} USDT`).join('\n');
                        const summary = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${result.data.processed || 0}${result.data.errors ? `, –æ—à–∏–±–æ–∫: ${result.data.errors}` : ''}`;
                        alert(`–ë–∞–ª–∞–Ω—Å—ã –¥–ª—è ${username}:\n\n${balancesText}\n\n${summary}`);
                    } else {
                        alert(`–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${username} –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏–ª–∏ –±–∞–ª–∞–Ω—Å—ã –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã`);
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤:', error);
                const button = event?.target || document.querySelector(`button[onclick*="checkFermBalances('${userId}'"]`);
                if (button) {
                    button.disabled = false;
                    button.textContent = '–ë–∞–ª–∞–Ω—Å—ã';
                }
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        }
        
        async function exportFermAccounts(userId, username) {
            try {
                const response = await fetch(`/api/ferm/admin/users/${userId}/accounts/export`, {
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.success) {
                    const blob = new Blob([result.data], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ferm-accounts-${username}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
            }
        }
        
        async function importFermAccounts(userId, username) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const text = await file.text();
                try {
                    const response = await fetch(`/api/ferm/admin/users/${userId}/accounts/import`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ data: text })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${result.data.added || 0}`);
                        loadUsers();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + result.error);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                }
            };
            input.click();
        }

        async function forceStopBot() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç?')) {
                return;
            }
            try {
                const response = await fetch('/api/admin/bot-force-stop', {
                    method: 'POST',
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.success) {
                    alert('–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    loadBotStatus();
                    loadQueue();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}"?`)) {
                return;
            }
            try {
                const response = await fetch(`/api/ferm/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.success) {
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (!username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                const response = await fetch('/api/ferm/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password, role })
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('createUserForm').reset();
                    loadUsers();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        });

        async function logout() {
            try {
                await fetch('/api/ferm/auth/logout', { method: 'POST', credentials: 'include' });
                window.location.href = '/ferm/login';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        (async () => {
            await loadCurrentUser();
            await loadBotStatus();
            await loadQueue();
            await loadUsers();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                loadBotStatus();
                loadQueue();
            }, 5000);
        })();
    </script>
</body>
</html>
