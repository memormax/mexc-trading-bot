#!/bin/bash

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ð¾Ð³Ð¾ Ð±Ð¾Ñ‚Ð°
# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ ÑˆÐ°Ð³Ð¸ 8-14 Ð¸Ð· COMPLETE_SETUP_GUIDE.md

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ ÑÐµÑ€Ð²ÐµÑ€Ð°..."
echo ""

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¾Ñ‚ root
if [ "$EUID" -ne 0 ]; then 
    error "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ñ‚ root: sudo bash setup-server.sh"
    exit 1
fi

info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Node.js
if ! command -v node &> /dev/null; then
    error "Node.js Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½! Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑˆÐ°Ð³Ð¸ 4-5 Ð¸Ð· Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸."
    exit 1
fi

NODE_VERSION=$(node --version)
info "Node.js ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: $NODE_VERSION"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PM2
if ! command -v pm2 &> /dev/null; then
    error "PM2 Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½! Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑˆÐ°Ð³ 5 Ð¸Ð· Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸."
    exit 1
fi

PM2_VERSION=$(pm2 --version)
info "PM2 ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: Ð²ÐµÑ€ÑÐ¸Ñ $PM2_VERSION"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Nginx
if ! command -v nginx &> /dev/null; then
    error "Nginx Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½! Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑˆÐ°Ð³ 6 Ð¸Ð· Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸."
    exit 1
fi

NGINX_VERSION=$(nginx -v 2>&1 | cut -d' ' -f3)
info "Nginx ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½: $NGINX_VERSION"

echo ""
info "Ð’ÑÐµ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹!"
echo ""

# ============================================
# Ð¨ÐÐ“ 8: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
# ============================================
info "Ð¨ÐÐ“ 8: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."

if [ ! -d "/root/unified-bot" ]; then
    warn "ÐŸÐ°Ð¿ÐºÐ° /root/unified-bot Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
    warn "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€:"
    warn "ÐÐ° Ð²Ð°ÑˆÐµÐ¼ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:"
    warn "  scp -r unified-bot root@YOUR_SERVER_IP:/root/"
    warn ""
    read -p "Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        error "Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ½Ð¾Ð²Ð°."
        exit 1
    fi
fi

if [ ! -f "/root/unified-bot/package.json" ]; then
    error "Ð¤Ð°Ð¹Ð» package.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½! Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾."
    exit 1
fi

info "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² /root/unified-bot"

# ============================================
# Ð¨ÐÐ“ 9: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
# ============================================
info "Ð¨ÐÐ“ 9: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
cd /root/unified-bot

info "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ npm install (ÑÑ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ 2-3 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹)..."
npm install

if [ $? -ne 0 ]; then
    error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹!"
    exit 1
fi

info "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"

# ============================================
# Ð¨ÐÐ“ 10: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
# ============================================
info "Ð¨ÐÐ“ 10: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
info "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ npm run build..."

npm run build

if [ $? -ne 0 ]; then
    error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ±Ð¾Ñ€ÐºÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ!"
    exit 1
fi

if [ ! -f "/root/unified-bot/dist/server.js" ]; then
    error "Ð¤Ð°Ð¹Ð» dist/server.js Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸!"
    exit 1
fi

info "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð½Ð¾!"

# ============================================
# Ð¨ÐÐ“ 11: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
# ============================================
info "Ð¨ÐÐ“ 11: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."

if [ ! -f "/root/unified-bot/.env" ]; then
    info "Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ„Ð°Ð¹Ð» .env..."
    cat > /root/unified-bot/.env << EOF
PORT=3002
HOST=0.0.0.0
NODE_ENV=production
EOF
    info "Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½!"
else
    warn "Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ."
fi

# ============================================
# Ð¨ÐÐ“ 12: Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· PM2
# ============================================
info "Ð¨ÐÐ“ 12: Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· PM2..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð»Ð¸ ÑƒÐ¶Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
if pm2 list | grep -q "mexc-trading-bot"; then
    warn "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð² PM2, Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÑŽ..."
    pm2 restart mexc-trading-bot
else
    info "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· PM2..."
    cd /root/unified-bot
    pm2 start ecosystem.config.js
fi

# ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°
sleep 3

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
if pm2 list | grep -q "mexc-trading-bot.*online"; then
    info "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾!"
else
    error "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¾ÑÑŒ! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: pm2 logs mexc-trading-bot"
    pm2 logs mexc-trading-bot --lines 20
    exit 1
fi

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ PM2
info "Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ PM2..."
pm2 save

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
info "ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÑŽ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑÐµÑ€Ð²ÐµÑ€Ð°..."
STARTUP_CMD=$(pm2 startup | grep -oP 'sudo.*')
if [ ! -z "$STARTUP_CMD" ]; then
    info "Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°..."
    eval $STARTUP_CMD
else
    warn "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°. Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ: pm2 startup"
fi

# ============================================
# Ð¨ÐÐ“ 13: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx
# ============================================
info "Ð¨ÐÐ“ 13: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx..."

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ IP Ð°Ð´Ñ€ÐµÑÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°
SERVER_IP=$(hostname -I | awk '{print $1}')

info "IP Ð°Ð´Ñ€ÐµÑ ÑÐµÑ€Ð²ÐµÑ€Ð°: $SERVER_IP"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
NGINX_CONFIG="/etc/nginx/sites-available/mexc-bot"

info "Ð¡Ð¾Ð·Ð´Ð°ÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx..."
cat > $NGINX_CONFIG << EOF
server {
    listen 80;
    server_name $SERVER_IP;

    # Ð›Ð¾Ð³Ð¸
    access_log /var/log/nginx/mexc-bot-access.log;
    error_log /var/log/nginx/mexc-bot-error.log;

    # ÐŸÑ€Ð¾ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
    location / {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        
        # Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹ Ð´Ð»Ñ WebSocket
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }
}
EOF

info "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Nginx ÑÐ¾Ð·Ð´Ð°Ð½Ð°!"

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
if [ ! -L "/etc/nginx/sites-enabled/mexc-bot" ]; then
    info "ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx..."
    ln -s /etc/nginx/sites-available/mexc-bot /etc/nginx/sites-enabled/
else
    warn "Ð¡Ð¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÑÑ‹Ð»ÐºÐ° ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚."
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx..."
if nginx -t; then
    info "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Nginx ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°!"
else
    error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx!"
    exit 1
fi

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Nginx
info "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÑŽ Nginx..."
systemctl restart nginx

if systemctl is-active --quiet nginx; then
    info "Nginx ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
else
    error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐµ Nginx!"
    systemctl status nginx
    exit 1
fi

# ============================================
# Ð¨ÐÐ“ 14: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
# ============================================
info "Ð¨ÐÐ“ 14: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."

sleep 2

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· curl..."
HTTP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/api/health || echo "000")

if [ "$HTTP_RESPONSE" = "200" ]; then
    info "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚! HTTP ÐºÐ¾Ð´: $HTTP_RESPONSE"
else
    warn "âš ï¸  ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð²ÐµÑ€Ð½ÑƒÐ»Ð¾ ÐºÐ¾Ð´: $HTTP_RESPONSE"
    warn "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: pm2 logs mexc-trading-bot"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PM2
info "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ PM2:"
pm2 status

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Nginx
info "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Nginx:"
systemctl status nginx --no-pager -l

# ============================================
# Ð˜Ð¢ÐžÐ“ÐžÐ’ÐÐ¯ Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯
# ============================================
echo ""
echo "=========================================="
echo -e "${GREEN}âœ… ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ!${NC}"
echo "=========================================="
echo ""
info "Ð’Ð°ÑˆÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ:"
echo -e "${GREEN}http://$SERVER_IP${NC}"
echo ""
info "ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "  pm2 status                    # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
echo "  pm2 logs mexc-trading-bot      # ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð²"
echo "  pm2 restart mexc-trading-bot   # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
echo "  pm2 monit                     # ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³"
echo ""
info "Ð”Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ñ‡ÐµÑ€ÐµÐ· Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Ð¾Ñ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ:"
echo -e "${GREEN}http://$SERVER_IP${NC}"
echo ""
warn "Ð’ÐÐ–ÐÐž: Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð» Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾!"
echo "  ufw status                    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°"
echo ""

