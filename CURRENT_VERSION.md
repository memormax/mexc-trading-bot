# Текущая версия проекта

**Версия:** 2.0.0 (Stable)  
**Дата:** 2026-02-05 16:01:32  
**Статус:** ✅ Стабильная рабочая версия с Многопользовательской системой, Flipbot авторизацией и Объединенной админ-панелью  
**Бекап:** `backup/backup_2026-02-05_16-01-32/`

## Основные возможности

### ✅ Многопользовательская система
- **Ferm Service:**
  - Express-Session для управления сессиями пользователей
  - Изоляция данных по userId (каждый пользователь имеет свои аккаунты и логи)
  - Файловое хранение пользователей (`data/users.json`)
  - Файловое хранение данных пользователей (`data/users/{userId}/ferm-accounts.json`, `ferm-history.json`, `ferm-logs.json`)
  - Авторизация через `/ferm/login`
  - Админ-логин: `lunar` / `adventures`

- **Flipbot Service:**
  - Авторизация через `/flip/login`
  - Изоляция данных по userId (`data/users/{userId}/flip-accounts.json`, `flip-settings.json`, `flip-config.json`)
  - Персистентное хранение настроек и аккаунтов
  - Отображение логина и кнопки выхода в интерфейсе
  - Кнопка "Админ-панель" для администраторов

### ✅ Объединенная админ-панель (`/god/`)
- **Управление пользователями:**
  - Создание, удаление пользователей
  - Просмотр данных пользователей (Ferm и Flipbot)
  - Двухколоночное отображение: Ferm слева, Flipbot справа

- **Ferm управление:**
  - Просмотр количества аккаунтов пользователя
  - Кнопка "Балансы" - проверка балансов всех аккаунтов пользователя
  - Кнопка "Экспорт" - экспорт аккаунтов пользователя в .txt файл
  - Кнопка "Импорт" - импорт аккаунтов пользователя из .txt файла

- **Flipbot управление:**
  - Просмотр количества аккаунтов пользователя
  - Просмотр статуса мультиаккаунтинга
  - Отображение текущего пользователя, который торгует ботом
  - Просмотр очереди пользователей

- **Управление Flipbot:**
  - Статус бота (запущен/остановлен)
  - Текущий пользователь, который торгует
  - Очередь пользователей
  - Кнопка "Принудительно остановить" для разблокировки бота

### ✅ Система блокировки Flipbot
- Только один пользователь может запускать Flipbot одновременно
- Автоматическая очередь для других пользователей
- Автоматическое переключение на следующего пользователя в очереди после завершения торговли
- Персистентная блокировка (сохраняется в `data/bot-lock.json`)
- Блокировка сохраняется даже после выхода пользователя из системы
- Админ может принудительно разблокировать бота

### ✅ Ferm Service - Мультиаккаунтная торговля
- Полностью рабочая система управления несколькими аккаунтами
- Автоматическое переключение между аккаунтами при:
  - Обнаружении комиссии
  - Достижении лимита времени торговли
  - Достижении целевого баланса
  - Ошибках открытия/закрытия позиций
- Проверка доступности аккаунтов перед переключением
- Автоматическая остановка только когда все аккаунты проторгованы

### ✅ Система отчетов
- Автоматическое формирование отчетов после остановки аккаунта
- Страница отчетов с полной статистикой
- Персистентное хранилище: отчеты сохраняются в `data/users/{userId}/ferm-reports.json`
- Безопасность: API ключи отображаются в маскированном формате

### ✅ Торговля
- Ручная торговля через веб-интерфейс
- Автоматический арбитраж между Binance и MEXC (Flipbot)
- Проверка комиссии после каждой сделки
- Автоматическое закрытие позиций при обнаружении комиссии
- Проверка ликвидности перед открытием позиции

### ✅ UI улучшения
- Главная страница (`/`) - выбор между Ferm и Flipbot
- Ferm страница - стилизованный интерфейс, логин, кнопка выхода, админ-панель
- Flipbot страница - логин, кнопка выхода, админ-панель
- Админ-панель - объединенная для обоих сервисов
- Убраны эмодзи из интерфейса (кроме панели "Аккаунты" в Ferm)
- Кнопки LONG/SHORT вместо ЛОНГ/ШОРТ
- Частичное закрытие позиций (0-100%)
- Упрощенный ввод символов (можно вводить "UNI" вместо "UNI_USDT")
- Группировка аккаунтов (4 группы по 25%)
- Оптимизированная проверка позиций (только аккаунты с открытыми позициями)

## Структура проекта

```
unified-bot/
├── server.ts              # Основной файл приложения
├── package.json           # Зависимости проекта
├── tsconfig.json          # Конфигурация TypeScript
├── services/              # Сервисы
│   ├── ferm/             # Ferm Service (мультиаккаунтная торговля)
│   │   ├── ui/           # UI файлы
│   │   ├── service.ts    # Основная логика
│   │   ├── routes.ts     # API маршруты
│   │   ├── handlers.ts   # Обработчики запросов
│   │   ├── auth.ts       # Авторизация (реэкспорт из shared)
│   │   └── users.ts       # Управление пользователями (реэкспорт из shared)
│   ├── flip/             # Flipbot Service (арбитражный бот)
│   │   ├── ui/           # UI файлы
│   │   ├── routes.ts     # API маршруты
│   │   ├── handlers.ts   # Обработчики запросов
│   │   ├── user-data.ts  # Управление данными пользователей
│   │   └── index.ts      # Регистрация маршрутов
│   └── shared/           # Общие модули
│       ├── auth.ts       # Авторизация (express-session)
│       ├── users.ts      # Управление пользователями
│       ├── bot-lock.ts   # Блокировка Flipbot
│       └── ui/           # Общие UI файлы (админ-панель)
├── src/                   # Исходные файлы
│   ├── api-key-client.ts
│   ├── trading-handler.ts
│   ├── monitor/
│   ├── trading/
│   └── websocket/
├── ui/                    # UI главной страницы
│   └── welcome.html      # Страница выбора сервиса
├── data/                  # Данные
│   ├── users.json        # Пользователи
│   ├── bot-lock.json     # Блокировка Flipbot
│   └── users/            # Данные пользователей
│       └── {userId}/    # Данные конкретного пользователя
│           ├── ferm-accounts.json
│           ├── ferm-history.json
│           ├── ferm-logs.json
│           ├── ferm-reports.json
│           ├── flip-accounts.json
│           ├── flip-settings.json
│           └── flip-config.json
├── docs/                  # Документация
└── backup/               # Бекапы версий
```

## API Endpoints

### Ferm Service
- `GET /ferm/` - Главная страница (требует авторизации)
- `GET /ferm/login` - Страница авторизации
- `POST /api/ferm/auth/login` - Вход в систему
- `POST /api/ferm/auth/logout` - Выход из системы
- `GET /api/ferm/auth/check` - Проверка сессии
- `GET /api/ferm/accounts` - Получить аккаунты пользователя
- `POST /api/ferm/accounts` - Добавить аккаунт
- `PUT /api/ferm/accounts/:accountId` - Обновить аккаунт
- `DELETE /api/ferm/accounts/:accountId` - Удалить аккаунт
- `POST /api/ferm/operations/submit-order` - Создать ордер на выбранных аккаунтах
- `POST /api/ferm/operations/cancel-all` - Отменить все ордера
- `POST /api/ferm/operations/close-positions` - Закрыть позиции
- `POST /api/ferm/operations/partial-close-positions` - Частично закрыть позиции
- `GET /api/ferm/status/balance/:accountId` - Получить баланс аккаунта
- `GET /api/ferm/status/positions/:accountId` - Получить позиции аккаунта
- `GET /api/ferm/logs` - Получить логи операций
- `POST /api/ferm/logs` - Добавить лог операции
- `DELETE /api/ferm/logs` - Очистить логи

### Flipbot Service
- `GET /flip/` - Главная страница (требует авторизации)
- `GET /flip/login` - Страница авторизации
- `POST /api/flip/auth/login` - Вход в систему
- `POST /api/flip/auth/logout` - Выход из системы
- `GET /api/flip/auth/check` - Проверка сессии
- `GET /api/flip/settings` - Получить настройки пользователя
- `POST /api/flip/settings` - Сохранить настройки пользователя
- `GET /api/flip/multi-account/config` - Получить конфигурацию мультиаккаунтинга
- `POST /api/flip/multi-account/config` - Сохранить конфигурацию мультиаккаунтинга
- `GET /api/flip/multi-account/accounts` - Получить аккаунты пользователя
- `POST /api/flip/multi-account/accounts` - Добавить аккаунт
- `PUT /api/flip/multi-account/accounts/:id` - Обновить аккаунт
- `DELETE /api/flip/multi-account/accounts/:id` - Удалить аккаунт
- `POST /api/flip/start` - Запустить бота (с проверкой блокировки)
- `POST /api/flip/stop` - Остановить бота

### Админ-панель (`/god/`)
- `GET /god/` - Админ-панель (требует админ прав)
- `GET /api/admin/users-data` - Получить данные всех пользователей
- `GET /api/admin/bot-status` - Статус Flipbot
- `GET /api/admin/bot-queue` - Очередь пользователей Flipbot
- `POST /api/admin/bot-force-stop` - Принудительно остановить Flipbot
- `POST /api/ferm/admin/users/:userId/check-balances` - Проверить балансы пользователя
- `GET /api/ferm/admin/users/:userId/accounts/export` - Экспортировать аккаунты пользователя
- `POST /api/ferm/admin/users/:userId/accounts/import` - Импортировать аккаунты пользователя

## Файлы данных

### Пользователи
- `data/users.json` - Список всех пользователей (id, username, passwordHash, role, createdAt)

### Ferm Service
- `data/users/{userId}/ferm-accounts.json` - Аккаунты пользователя
- `data/users/{userId}/ferm-history.json` - История операций
- `data/users/{userId}/ferm-logs.json` - Логи операций (последние 100 записей)
- `data/users/{userId}/ferm-reports.json` - Отчеты по аккаунтам

### Flipbot Service
- `data/users/{userId}/flip-accounts.json` - Аккаунты пользователя
- `data/users/{userId}/flip-settings.json` - Настройки арбитража
- `data/users/{userId}/flip-config.json` - Конфигурация мультиаккаунтинга

### Системные
- `data/bot-lock.json` - Блокировка Flipbot (currentUserId, currentUsername, startTime, queue)

## Последние изменения

- **2026-02-05 16:01:32:** Версия 2.0.0 - Многопользовательская система для Flipbot
  - ✅ Авторизация для Flipbot (`/flip/login`)
  - ✅ Изоляция данных Flipbot по userId
  - ✅ Персистентное хранение настроек и аккаунтов Flipbot
  - ✅ Система блокировки Flipbot (только один пользователь может торговать)
  - ✅ Очередь пользователей Flipbot
  - ✅ Автоматическое переключение между пользователями
  - ✅ Объединенная админ-панель (`/god/`) для Ferm и Flipbot
  - ✅ Отображение логина и кнопки выхода в Flipbot
  - ✅ Кнопка "Админ-панель" в Flipbot для администраторов
  - ✅ Исправлена проверка балансов в админ-панели
  - ✅ Добавлены endpoints для экспорта/импорта аккаунтов в админ-панели

- **2026-02-05 13:06:55:** Версия 1.1.0 - Многопользовательская система для Ferm
  - ✅ Реализована многопользовательская система авторизации для Ferm Service
  - ✅ Express-Session для управления сессиями пользователей
  - ✅ Изоляция данных по userId (каждый пользователь имеет свои аккаунты и логи)
  - ✅ Админ-панель для управления пользователями (`/ferm/god/`)
  - ✅ Экспорт/импорт аккаунтов для пользователей и админов
  - ✅ Персистентное логирование операций (логи сохраняются между сессиями)
  - ✅ Индивидуальные логи для каждого пользователя
  - ✅ Автоматическая загрузка логов при обновлении страницы
  - ✅ Улучшенный UI: кнопка "Админ-панель" для админов, обновленный стиль главной страницы
  - ✅ Убраны всплывающие окна при импорте в админке

- **2026-02-04 20:44:03:** Версия 1.0.0 - Rate Limiting и Батчинг
  - ✅ Реализован класс RateLimiter для управления частотой запросов
  - ✅ Автоматическое разбиение запросов на батчи (5 аккаунтов на батч)
  - ✅ Задержка 150мс между батчами
  - ✅ Автоматический retry при rate limit (до 3 попыток с экспоненциальной задержкой)
  - ✅ Повышение успешности операций с 60-70% до 95-99% при работе с 50+ аккаунтами

## Запуск

```bash
# Установка зависимостей
npm install

# Сборка проекта
npm run build

# Запуск
npm start

# Или в режиме разработки
npm run dev
```

## Доступ к сервисам

- **Главная страница:** `http://localhost:3002/`
- **Ferm Service:** `http://localhost:3002/ferm/`
- **Flipbot Service:** `http://localhost:3002/flip/`
- **Админ-панель:** `http://localhost:3002/god/`
- **Админ-логин:** `lunar` / `adventures`

## Документация

- **PROJECT_DOCUMENTATION.md** - Полная документация проекта
- **SERVICES_STRUCTURE.md** - Структура сервисов
- **services/ferm/README.md** - Документация Ferm Service
- **services/flip/README.md** - Документация Flipbot Service
- **README.md** - Основная документация и инструкции

## Бекапы

Все бекапы версий проекта хранятся в папке `backup/`. Старые бекапы не удаляются для возможности отката.

**Последний бекап:** `backup/backup_2026-02-05_16-01-32/`
