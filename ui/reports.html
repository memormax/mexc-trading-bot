<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á–µ—Ç—ã –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º - MEXC Trading Bot</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .reports-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 10px;
        }
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .reports-table {
            width: 100%;
            border-collapse: collapse;
            background: #1e293b;
            border-radius: 8px;
            overflow: hidden;
        }
        .reports-table th,
        .reports-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #334155;
            font-size: 12px;
        }
        .reports-table th {
            background: #0f172a;
            color: #60a5fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .reports-table tr:hover {
            background: #334155;
        }
        .reports-table td {
            color: #e2e8f0;
        }
        .account-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .account-name {
            font-weight: 600;
            color: #60a5fa;
        }
        .account-key {
            font-size: 11px;
            color: #94a3b8;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        .trading-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .profit-positive {
            color: #10b981;
        }
        .profit-negative {
            color: #ef4444;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        .btn-clear {
            padding: 8px 16px;
        }
    </style>
</head>
<body>
    <div class="reports-container">
        <header>
            <h1>üìä –û—Ç—á–µ—Ç—ã –ø–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º –∞–∫–∫–∞—É–Ω—Ç–∞–º</h1>
            <div class="connection-status">
                <span class="status-dot"></span>
                <span id="connectionStatus">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </header>

        <div class="reports-header">
            <div>
                <button class="btn-secondary" onclick="loadReports()" style="margin-right: 10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn-danger btn-clear" onclick="clearReports()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div style="color: #94a3b8; font-size: 12px;">
                –í—Å–µ–≥–æ –æ—Ç—á–µ—Ç–æ–≤: <span id="reportsCount">0</span>
            </div>
        </div>

        <div class="card">
            <div id="reportsTableContainer">
                <table class="reports-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">–ê–∫–∫–∞—É–Ω—Ç –∏ –∫–ª—é—á–∏</th>
                            <th style="width: 30%;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏</th>
                            <th style="width: 25%;">–ë–∞–ª–∞–Ω—Å –∏ –æ–±—ä–µ–º</th>
                            <th style="width: 20%;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <tr>
                            <td colspan="3" class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–æ–≤...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function apiRequest(endpoint, options = {}) {
            try {
                const config = {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                };
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å body, —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                if (config.body && typeof config.body !== 'string') {
                    config.body = JSON.stringify(config.body);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            if (hours > 0) {
                return `${hours}—á ${mins}–º`;
            }
            return `${mins}–º`;
        }

        function formatNumber(num) {
            return num.toFixed(2);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏—è API –∫–ª—é—á–µ–π (–ø–µ—Ä–≤—ã–µ 4 —Å–∏–º–≤–æ–ª–∞ + ... + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞)
        function maskApiKey(key) {
            if (!key || key.length <= 8) {
                return key; // –ï—Å–ª–∏ –∫–ª—é—á —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            }
            return key.substring(0, 4) + '...' + key.substring(key.length - 4);
        }

        function renderReports(reports) {
            const tbody = document.getElementById('reportsTableBody');
            const countSpan = document.getElementById('reportsCount');
            
            countSpan.textContent = reports.length;

            if (reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">–ù–µ—Ç –æ—Ç—á–µ—Ç–æ–≤. –û—Ç—á–µ—Ç—ã –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–∞—Ö.</td></tr>';
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            const sortedReports = [...reports].sort((a, b) => b.timestamp - a.timestamp);

            tbody.innerHTML = sortedReports.map(report => {
                const profitClass = report.profit >= 0 ? 'profit-positive' : 'profit-negative';
                const profitSign = report.profit >= 0 ? '+' : '';
                
                return `
                    <tr>
                        <td>
                            <div class="account-info">
                                <div class="account-name">${report.accountName}</div>
                                <div class="account-key">API Key: ${maskApiKey(report.apiKey)}</div>
                                <div class="account-key">API Secret: ${maskApiKey(report.apiSecret)}</div>
                                <div class="account-key">WEB Token: ${maskApiKey(report.webToken)}</div>
                            </div>
                        </td>
                        <td>
                            <div class="trading-stats">
                                <div><strong>–í—Ä–µ–º—è —Ç–æ—Ä–≥–æ–≤–ª–∏:</strong></div>
                                <div>${formatDateTime(report.startTime)} - ${formatDateTime(report.endTime)}</div>
                                <div style="margin-top: 8px;"><strong>–û–±—â–µ–µ –≤—Ä–µ–º—è:</strong> ${formatTime(report.tradingTimeMinutes)}</div>
                                <div style="margin-top: 8px;"><strong>–°–¥–µ–ª–æ–∫:</strong> ${report.tradesCount}</div>
                                <div style="margin-top: 8px;"><strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:</strong> ${report.stopReason}</div>
                            </div>
                        </td>
                        <td>
                            <div class="trading-stats">
                                <div><strong>–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:</strong> ${formatNumber(report.initialBalance)} USDT</div>
                                <div><strong>–§–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:</strong> ${formatNumber(report.finalBalance)} USDT</div>
                                <div class="${profitClass}"><strong>–ü—Ä–æ—Ñ–∏—Ç:</strong> ${profitSign}${formatNumber(report.profit)} USDT</div>
                                <div style="margin-top: 8px;"><strong>–ü—Ä–æ—Ç–æ—Ä–≥–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–º:</strong> ${formatNumber(report.totalTradedVolume)} USDT</div>
                            </div>
                        </td>
                        <td>
                            <div class="balance-controls" style="display: flex; flex-direction: column; gap: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button class="btn-secondary" style="font-size: 11px; padding: 6px; flex: 0 0 auto;" onclick="getSpotBalance('${report.apiKey}', '${report.apiSecret}', '${report.accountName}', this)">
                                        üí∞ –ë–∞–ª–∞–Ω—Å —Å–ø–æ—Ç–∞
                                    </button>
                                    <span class="spot-balance-${report.accountName.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size: 11px; color: #94a3b8; flex: 1;"></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button class="btn-secondary" style="font-size: 11px; padding: 6px; flex: 0 0 auto;" onclick="getFuturesBalance('${report.apiKey}', '${report.apiSecret}', '${report.accountName}', this)">
                                        üìä –ë–∞–ª–∞–Ω—Å —Ñ—å—é—á–µ–π
                                    </button>
                                    <span class="futures-balance-${report.accountName.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size: 11px; color: #94a3b8; flex: 1;"></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button class="btn-secondary" style="font-size: 11px; padding: 6px; flex: 0 0 auto;" onclick="transferSpotToFutures('${report.apiKey}', '${report.apiSecret}', '${report.accountName}', this)">
                                        ‚û°Ô∏è –°–ø–æ—Ç ‚Üí –§—å—é—á–∏
                                    </button>
                                    <span class="transfer-status-spot-futures-${report.accountName.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size: 11px; flex: 1;"></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button class="btn-secondary" style="font-size: 11px; padding: 6px; flex: 0 0 auto;" onclick="transferFuturesToSpot('${report.apiKey}', '${report.apiSecret}', '${report.accountName}', this)">
                                        ‚¨ÖÔ∏è –§—å—é—á–∏ ‚Üí –°–ø–æ—Ç
                                    </button>
                                    <span class="transfer-status-futures-spot-${report.accountName.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-size: 11px; flex: 1;"></span>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadReports() {
            try {
                const result = await apiRequest('/api/account-reports');
                if (result.success) {
                    renderReports(result.data);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:', result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:', error);
                document.getElementById('reportsTableBody').innerHTML = 
                    '<tr><td colspan="4" class="empty-state" style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤</td></tr>';
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–∞–º–∏
        async function getSpotBalance(apiKey, apiSecret, accountName, buttonElement) {
            const safeName = accountName.replace(/[^a-zA-Z0-9]/g, '_');
            const balanceElement = document.querySelector(`.spot-balance-${safeName}`);
            
            if (balanceElement) {
                balanceElement.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                balanceElement.style.color = '#94a3b8';
            }
            
            try {
                const result = await apiRequest('/api/reports/spot-balance', {
                    method: 'POST',
                    body: JSON.stringify({ apiKey, apiSecret })
                });
                
                if (result.success && balanceElement) {
                    // –ü–∞—Ä—Å–∏–º –±–∞–ª–∞–Ω—Å –∏–∑ –æ—Ç–≤–µ—Ç–∞
                    let balanceText = '';
                    if (result.data && result.data.balances) {
                        const usdtBalance = result.data.balances.find(b => b.asset === 'USDT');
                        if (usdtBalance) {
                            const free = parseFloat(usdtBalance.free);
                            const locked = parseFloat(usdtBalance.locked);
                            if (free > 0 || locked > 0) {
                                balanceText = `${free.toFixed(2)} USDT`;
                                if (locked > 0) {
                                    balanceText += ` (–∑–∞–±–ª–æ–∫: ${locked.toFixed(2)})`;
                                }
                            } else {
                                balanceText = '0 USDT';
                            }
                        } else {
                            // –ò—â–µ–º –ø–µ—Ä–≤—ã–π –±–∞–ª–∞–Ω—Å —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                            const nonZeroBalance = result.data.balances.find(b => parseFloat(b.free) > 0 || parseFloat(b.locked) > 0);
                            if (nonZeroBalance) {
                                balanceText = `${nonZeroBalance.asset}: ${parseFloat(nonZeroBalance.free).toFixed(4)}`;
                            } else {
                                balanceText = '–ù–µ—Ç –±–∞–ª–∞–Ω—Å–∞';
                            }
                        }
                    } else {
                        balanceText = '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞';
                    }
                    balanceElement.textContent = balanceText;
                    balanceElement.style.color = '#60a5fa';
                } else {
                    if (balanceElement) {
                        balanceElement.textContent = `–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                        balanceElement.style.color = '#ef4444';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å–ø–æ—Ç–∞:', error);
                if (balanceElement) {
                    balanceElement.textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞';
                    balanceElement.style.color = '#ef4444';
                }
            }
        }

        async function getFuturesBalance(apiKey, apiSecret, accountName, buttonElement) {
            const safeName = accountName.replace(/[^a-zA-Z0-9]/g, '_');
            const balanceElement = document.querySelector(`.futures-balance-${safeName}`);
            
            if (balanceElement) {
                balanceElement.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                balanceElement.style.color = '#94a3b8';
            }
            
            try {
                const result = await apiRequest('/api/reports/futures-balance', {
                    method: 'POST',
                    body: JSON.stringify({ apiKey, apiSecret })
                });
                
                if (result.success && balanceElement) {
                    // –ü–∞—Ä—Å–∏–º –±–∞–ª–∞–Ω—Å –∏–∑ –æ—Ç–≤–µ—Ç–∞
                    let balanceText = '';
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
                    if (result.data) {
                        // –§–æ—Ä–º–∞—Ç 1: result.data.data
                        if (result.data.data) {
                            const data = result.data.data;
                            if (data.availableBalance !== undefined) {
                                balanceText = `${parseFloat(data.availableBalance).toFixed(2)} USDT`;
                                if (data.frozenBalance && parseFloat(data.frozenBalance) > 0) {
                                    balanceText += ` (–∑–∞–±–ª–æ–∫: ${parseFloat(data.frozenBalance).toFixed(2)})`;
                                }
                            } else if (data.totalBalance !== undefined) {
                                balanceText = `${parseFloat(data.totalBalance).toFixed(2)} USDT`;
                            } else if (data.balance !== undefined) {
                                balanceText = `${parseFloat(data.balance).toFixed(2)} USDT`;
                            }
                        }
                        // –§–æ—Ä–º–∞—Ç 2: result.data –Ω–∞–ø—Ä—è–º—É—é
                        else if (result.data.availableBalance !== undefined) {
                            balanceText = `${parseFloat(result.data.availableBalance).toFixed(2)} USDT`;
                        } else if (result.data.totalBalance !== undefined) {
                            balanceText = `${parseFloat(result.data.totalBalance).toFixed(2)} USDT`;
                        } else if (result.data.balance !== undefined) {
                            balanceText = `${parseFloat(result.data.balance).toFixed(2)} USDT`;
                        }
                        // –§–æ—Ä–º–∞—Ç 3: –º–∞—Å—Å–∏–≤ —Å –±–∞–ª–∞–Ω—Å–∞–º–∏
                        else if (Array.isArray(result.data) && result.data.length > 0) {
                            const usdtAsset = result.data.find(a => a.currency === 'USDT' || a.asset === 'USDT');
                            if (usdtAsset) {
                                balanceText = `${parseFloat(usdtAsset.availableBalance || usdtAsset.balance || 0).toFixed(2)} USDT`;
                            }
                        }
                    }
                    
                    if (!balanceText) {
                        balanceText = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                        console.log('[REPORTS] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞ —Ñ—å—é—á–µ—Ä—Å–æ–≤:', result.data);
                    }
                    
                    balanceElement.textContent = balanceText;
                    balanceElement.style.color = '#60a5fa';
                } else {
                    if (balanceElement) {
                        balanceElement.textContent = `–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                        balanceElement.style.color = '#ef4444';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Ñ—å—é—á–µ—Ä—Å–æ–≤:', error);
                if (balanceElement) {
                    balanceElement.textContent = '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞';
                    balanceElement.style.color = '#ef4444';
                }
            }
        }

        async function transferSpotToFutures(apiKey, apiSecret, accountName, buttonElement) {
            const safeName = accountName.replace(/[^a-zA-Z0-9]/g, '_');
            const statusElement = document.querySelector(`.transfer-status-spot-futures-${safeName}`);
            
            if (statusElement) {
                statusElement.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...';
                statusElement.style.color = '#94a3b8';
            }

            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å —Å–ø–æ—Ç–∞
                const balanceResult = await apiRequest('/api/reports/spot-balance', {
                    method: 'POST',
                    body: JSON.stringify({ apiKey, apiSecret })
                });
                
                if (!balanceResult.success) {
                    if (statusElement) {
                        statusElement.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ${balanceResult.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                        statusElement.style.color = '#ef4444';
                    }
                    return;
                }

                // –ò—â–µ–º –±–∞–ª–∞–Ω—Å USDT
                let amount = 0;
                if (balanceResult.data && balanceResult.data.balances) {
                    const usdtBalance = balanceResult.data.balances.find(b => b.asset === 'USDT');
                    if (usdtBalance) {
                        amount = parseFloat(usdtBalance.free);
                    }
                }

                if (amount <= 0) {
                    if (statusElement) {
                        statusElement.textContent = '‚ùå –ù–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞';
                        statusElement.style.color = '#ef4444';
                    }
                    return;
                }

                if (statusElement) {
                    statusElement.textContent = `–ü–µ—Ä–µ–≤–æ–¥ ${amount.toFixed(2)} USDT...`;
                    statusElement.style.color = '#94a3b8';
                }

                // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥ –≤—Å–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
                const result = await apiRequest('/api/reports/transfer-spot-to-futures', {
                    method: 'POST',
                    body: JSON.stringify({ apiKey, apiSecret, asset: 'USDT', amount: amount })
                });
                
                if (result.success && statusElement) {
                    statusElement.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ';
                    statusElement.style.color = '#10b981';
                    // –ù–ï –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å - –ø—É—Å—Ç—å –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º
                } else {
                    if (statusElement) {
                        const errorMsg = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                        statusElement.textContent = `‚ùå ${errorMsg.length > 30 ? errorMsg.substring(0, 30) + '...' : errorMsg}`;
                        statusElement.style.color = '#ef4444';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å–æ —Å–ø–æ—Ç–∞ –Ω–∞ —Ñ—å—é—á–µ—Ä—Å—ã:', error);
                if (statusElement) {
                    statusElement.textContent = '‚ùå –û—à–∏–±–∫–∞';
                    statusElement.style.color = '#ef4444';
                }
            }
        }

        async function transferFuturesToSpot(apiKey, apiSecret, accountName, buttonElement) {
            const safeName = accountName.replace(/[^a-zA-Z0-9]/g, '_');
            const statusElement = document.querySelector(`.transfer-status-futures-spot-${safeName}`);
            
            if (statusElement) {
                statusElement.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞...';
                statusElement.style.color = '#94a3b8';
            }

            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å —Ñ—å—é—á–µ—Ä—Å–æ–≤
                const balanceResult = await apiRequest('/api/reports/futures-balance', {
                    method: 'POST',
                    body: JSON.stringify({ apiKey, apiSecret })
                });
                
                if (!balanceResult.success) {
                    if (statusElement) {
                        statusElement.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ${balanceResult.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                        statusElement.style.color = '#ef4444';
                    }
                    return;
                }

                // –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å USDT
                let amount = 0;
                if (balanceResult.data && balanceResult.data.data) {
                    const data = balanceResult.data.data;
                    if (data.availableBalance !== undefined) {
                        amount = parseFloat(data.availableBalance);
                    } else if (data.totalBalance !== undefined) {
                        amount = parseFloat(data.totalBalance);
                    }
                }

                if (amount <= 0) {
                    if (statusElement) {
                        statusElement.textContent = '‚ùå –ù–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞';
                        statusElement.style.color = '#ef4444';
                    }
                    return;
                }

                if (statusElement) {
                    statusElement.textContent = `–ü–µ—Ä–µ–≤–æ–¥ ${amount.toFixed(2)} USDT...`;
                    statusElement.style.color = '#94a3b8';
                }

                // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥ –≤—Å–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
                const result = await apiRequest('/api/reports/transfer-futures-to-spot', {
                    method: 'POST',
                    body: JSON.stringify({ apiKey, apiSecret, asset: 'USDT', amount: amount })
                });
                
                if (result.success && statusElement) {
                    statusElement.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ';
                    statusElement.style.color = '#10b981';
                    // –ù–ï –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å - –ø—É—Å—Ç—å –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º
                } else {
                    if (statusElement) {
                        const errorMsg = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                        statusElement.textContent = `‚ùå ${errorMsg.length > 30 ? errorMsg.substring(0, 30) + '...' : errorMsg}`;
                        statusElement.style.color = '#ef4444';
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å —Ñ—å—é—á–µ—Ä—Å–æ–≤ –Ω–∞ —Å–ø–æ—Ç:', error);
                if (statusElement) {
                    statusElement.textContent = '‚ùå –û—à–∏–±–∫–∞';
                    statusElement.style.color = '#ef4444';
                }
            }
        }

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.getSpotBalance = getSpotBalance;
        window.getFuturesBalance = getFuturesBalance;
        window.transferSpotToFutures = transferSpotToFutures;
        window.transferFuturesToSpot = transferFuturesToSpot;

        async function clearReports() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            try {
                const result = await apiRequest('/api/account-reports', {
                    method: 'DELETE'
                });
                if (result.success) {
                    alert('–í—Å–µ –æ—Ç—á–µ—Ç—ã –æ—á–∏—â–µ–Ω—ã');
                    loadReports();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –æ—Ç—á–µ—Ç–æ–≤: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –æ—Ç—á–µ—Ç–æ–≤:', error);
                alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –æ—Ç—á–µ—Ç–æ–≤');
            }
        }

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.maskApiKey = maskApiKey;
        window.loadReports = loadReports;
        window.clearReports = clearReports;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            loadReports();
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(loadReports, 5000);
        });
    </script>
</body>
</html>

